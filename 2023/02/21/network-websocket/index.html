<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 5.4.2">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"the-rings.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.18.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="WebSocketThe WebSocket protocol, described in the specification RFC 6455, provides a way to exchange data between browser and server via a persistent connection. The data can be passed in both directi">
<meta property="og:type" content="article">
<meta property="og:title" content="WebSocket协议">
<meta property="og:url" content="https://the-rings.github.io/2023/02/21/network-websocket/index.html">
<meta property="og:site_name" content="免逸">
<meta property="og:description" content="WebSocketThe WebSocket protocol, described in the specification RFC 6455, provides a way to exchange data between browser and server via a persistent connection. The data can be passed in both directi">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://the-rings.github.io/websocket-handshake.svg">
<meta property="article:published_time" content="2023-02-21T13:40:08.000Z">
<meta property="article:modified_time" content="2023-08-06T03:08:15.010Z">
<meta property="article:author" content="The Rings">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://the-rings.github.io/websocket-handshake.svg">


<link rel="canonical" href="https://the-rings.github.io/2023/02/21/network-websocket/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://the-rings.github.io/2023/02/21/network-websocket/","path":"2023/02/21/network-websocket/","title":"WebSocket协议"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>WebSocket协议 | 免逸</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">免逸</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">下一代web开发是什么样的？下一代类报表系统是什么样的？</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#WebSocket"><span class="nav-number">1.</span> <span class="nav-text">WebSocket</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#A-simple-example"><span class="nav-number">1.1.</span> <span class="nav-text">A simple example</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Opening-a-websocket"><span class="nav-number">1.2.</span> <span class="nav-text">Opening a websocket</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Extensions-and-subprotocols"><span class="nav-number">1.2.1.</span> <span class="nav-text">Extensions and subprotocols</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Data-transfer"><span class="nav-number">1.3.</span> <span class="nav-text">Data transfer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Rate-limiting"><span class="nav-number">1.4.</span> <span class="nav-text">Rate limiting</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Connection-close"><span class="nav-number">1.5.</span> <span class="nav-text">Connection close</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Connection-state"><span class="nav-number">1.6.</span> <span class="nav-text">Connection state</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Chat-example"><span class="nav-number">1.7.</span> <span class="nav-text">Chat example</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Summary"><span class="nav-number">1.8.</span> <span class="nav-text">Summary</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">The Rings</p>
  <div class="site-description" itemprop="description">软件开发一直追求更加高效, 更加已维护甚至更易扩展的方式</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">55</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://the-rings.github.io/2023/02/21/network-websocket/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="The Rings">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="免逸">
      <meta itemprop="description" content="软件开发一直追求更加高效, 更加已维护甚至更易扩展的方式">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="WebSocket协议 | 免逸">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          WebSocket协议
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-02-21 21:40:08" itemprop="dateCreated datePublished" datetime="2023-02-21T21:40:08+08:00">2023-02-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h1><p>The <code>WebSocket</code> protocol, described in the specification <a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc6455">RFC 6455</a>, provides a way to exchange data between browser and server via a persistent connection. The data can be passed in both directions as “packets”, without breaking the connection and the need of additional HTTP-requests.</p>
<p>WebSocket is especially great for services that require continuous data exchange, e.g. online games, real-time trading systems and so on.</p>
<h2 id="A-simple-example"><a href="#A-simple-example" class="headerlink" title="A simple example"></a>A simple example</h2><p>To open a websocket connection, we need to create <code>new WebSocket</code> using the special protocol <code>ws</code> in the url:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> socket = <span class="keyword">new</span> WebSocket(<span class="string">&quot;*!*ws*/!*://javascript.info&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>There’s also encrypted <code>wss://</code> protocol. It’s like HTTPS for websockets.</p>
<figure class="highlight plaintext"><figcaption><span>header</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">The `wss://` protocol is not only encrypted, but also more reliable.</span><br><span class="line"></span><br><span class="line">That&#x27;s because `ws://` data is not encrypted, visible for any intermediary. Old proxy servers do not know about WebSocket, they may see &quot;strange&quot; headers and abort the connection.</span><br><span class="line"></span><br><span class="line">On the other hand, `wss://` is WebSocket over TLS, (same as HTTPS is HTTP over TLS), the transport security layer encrypts the data at the sender and decrypts it at the receiver. So data packets are passed encrypted through proxies. They can&#x27;t see what&#x27;s inside and let them through.</span><br></pre></td></tr></table></figure>

<p>Once the socket is created, we should listen to events on it. There are totally 4 events:</p>
<ul>
<li><strong><code>open</code></strong> – connection established,</li>
<li><strong><code>message</code></strong> – data received,</li>
<li><strong><code>error</code></strong> – websocket error,</li>
<li><strong><code>close</code></strong> – connection closed.</li>
</ul>
<p>…And if we’d like to send something, then <code>socket.send(data)</code> will do that.</p>
<p>Here’s an example:</p>
<figure class="highlight js"><figcaption><span>run</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> socket = <span class="keyword">new</span> WebSocket(<span class="string">&quot;wss://javascript.info/article/websocket/demo/hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">socket.onopen = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  alert(<span class="string">&quot;[open] Connection established&quot;</span>);</span><br><span class="line">  alert(<span class="string">&quot;Sending to server&quot;</span>);</span><br><span class="line">  socket.send(<span class="string">&quot;My name is John&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">socket.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  alert(<span class="string">`[message] Data received from server: <span class="subst">$&#123;event.data&#125;</span>`</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">socket.onclose = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (event.wasClean) &#123;  </span><br><span class="line">    alert(<span class="string">`[close] Connection closed cleanly, code=<span class="subst">$&#123;event.code&#125;</span> reason=<span class="subst">$&#123;event.reason&#125;</span>`</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// e.g. server process killed or network down</span></span><br><span class="line">    <span class="comment">// event.code is usually 1006 in this case</span></span><br><span class="line">    alert(<span class="string">&#x27;[close] Connection died&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">socket.onerror = <span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">  alert(<span class="string">`[error]`</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>For demo purposes, there’s a small server <a href="demo/server.js">server.js</a> written in Node.js, for the example above, running. It responds with “Hello from server, John”, then waits 5 seconds and closes the connection.</p>
<p>So you’ll see events <code>open</code> -&gt; <code>message</code> -&gt; <code>close</code>.</p>
<p>That’s actually it, we can talk WebSocket already. Quite simple, isn’t it?</p>
<p>Now let’s talk more in-depth.</p>
<h2 id="Opening-a-websocket"><a href="#Opening-a-websocket" class="headerlink" title="Opening a websocket"></a>Opening a websocket</h2><p>When <code>new WebSocket(url)</code> is created, it starts connecting immediately.</p>
<p>During the connection, the browser (using headers) asks the server: “Do you support Websocket?” And if the server replies “yes”, then the talk continues in WebSocket protocol, which is not HTTP at all.</p>
<p><img src="/websocket-handshake.svg"></p>
<p>Here’s an example of browser headers for a request made by <code>new WebSocket(&quot;wss://javascript.info/chat&quot;)</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET /chat</span><br><span class="line">Host: javascript.info</span><br><span class="line">Origin: https://javascript.info</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Sec-WebSocket-Key: Iv8io/9s+lYFgZWcXczP8Q==</span><br><span class="line">Sec-WebSocket-Version: 13</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Origin</code> – the origin of the client page, e.g. <code>https://javascript.info</code>. WebSocket objects are cross-origin by nature. There are no special headers or other limitations. Old servers are unable to handle WebSocket anyway, so there are no compatibility issues. But the <code>Origin</code> header is important, as it allows the server to decide whether or not to talk WebSocket with this website.</li>
<li><code>Connection: Upgrade</code> – signals that the client would like to change the protocol.</li>
<li><code>Upgrade: websocket</code> – the requested protocol is “websocket”.</li>
<li><code>Sec-WebSocket-Key</code> – a random browser-generated key, used to ensure that the server supports WebSocket protocol. It’s random to prevent proxies from caching any following communication.</li>
<li><code>Sec-WebSocket-Version</code> – WebSocket protocol version, 13 is the current one.</li>
</ul>
<figure class="highlight plaintext"><figcaption><span>header</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">We can&#x27;t use `XMLHttpRequest` or `fetch` to make this kind of HTTP-request, because JavaScript is not allowed to set these headers.</span><br></pre></td></tr></table></figure>

<p>If the server agrees to switch to WebSocket, it should send code 101 response:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">101 Switching Protocols</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Accept: hsBlbuDTkk24srzEOTBUlZAlC2g=</span><br></pre></td></tr></table></figure>

<p>Here <code>Sec-WebSocket-Accept</code> is <code>Sec-WebSocket-Key</code>, recoded using a special algorithm. Upon seeing it, the browser understands that the server really does support the WebSocket protocol.</p>
<p>Afterwards, the data is transferred using the WebSocket protocol, we’ll see its structure (“frames”) soon. And that’s not HTTP at all.</p>
<h3 id="Extensions-and-subprotocols"><a href="#Extensions-and-subprotocols" class="headerlink" title="Extensions and subprotocols"></a>Extensions and subprotocols</h3><p>There may be additional headers <code>Sec-WebSocket-Extensions</code> and <code>Sec-WebSocket-Protocol</code> that describe extensions and subprotocols.</p>
<p>For instance:</p>
<ul>
<li><p><code>Sec-WebSocket-Extensions: deflate-frame</code> means that the browser supports data compression. An extension is something related to transferring the data, functionality that extends the WebSocket protocol. The header <code>Sec-WebSocket-Extensions</code> is sent automatically by the browser, with the list of all extensions it supports.</p>
</li>
<li><p><code>Sec-WebSocket-Protocol: soap, wamp</code> means that we’d like to transfer not just any data, but the data in <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/SOAP">SOAP</a> or WAMP (“The WebSocket Application Messaging Protocol”) protocols. WebSocket subprotocols are registered in the <a target="_blank" rel="noopener" href="https://www.iana.org/assignments/websocket/websocket.xml">IANA catalogue</a>. So, this header describes the data formats that we’re going to use.</p>
<p>  This optional header is set using the second parameter of <code>new WebSocket</code>. That’s the array of subprotocols, e.g. if we’d like to use SOAP or WAMP:</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> socket = <span class="keyword">new</span> WebSocket(<span class="string">&quot;wss://javascript.info/chat&quot;</span>, [<span class="string">&quot;soap&quot;</span>, <span class="string">&quot;wamp&quot;</span>]);</span><br></pre></td></tr></table></figure></li>
</ul>
<p>The server should respond with a list of protocols and extensions that it agrees to use.</p>
<p>For example, the request:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /chat</span><br><span class="line">Host: javascript.info</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Origin: https://javascript.info</span><br><span class="line">Sec-WebSocket-Key: Iv8io/9s+lYFgZWcXczP8Q==</span><br><span class="line">Sec-WebSocket-Version: 13</span><br><span class="line">*!*</span><br><span class="line">Sec-WebSocket-Extensions: deflate-frame</span><br><span class="line">Sec-WebSocket-Protocol: soap, wamp</span><br><span class="line">*/!*</span><br></pre></td></tr></table></figure>

<p>Response:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">101 Switching Protocols</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Accept: hsBlbuDTkk24srzEOTBUlZAlC2g=</span><br><span class="line">*!*</span><br><span class="line">Sec-WebSocket-Extensions: deflate-frame</span><br><span class="line">Sec-WebSocket-Protocol: soap</span><br><span class="line">*/!*</span><br></pre></td></tr></table></figure>

<p>Here the server responds that it supports the extension “deflate-frame”, and only SOAP of the requested subprotocols.</p>
<h2 id="Data-transfer"><a href="#Data-transfer" class="headerlink" title="Data transfer"></a>Data transfer</h2><p>WebSocket communication consists of “frames” – data fragments, that can be sent from either side, and can be of several kinds:</p>
<ul>
<li>“text frames” – contain text data that parties send to each other.</li>
<li>“binary data frames” – contain binary data that parties send to each other.</li>
<li>“ping/pong frames” are used to check the connection, sent from the server, the browser responds to these automatically.</li>
<li>there’s also “connection close frame” and a few other service frames.</li>
</ul>
<p>In the browser, we directly work only with text or binary frames.</p>
<p><strong>WebSocket <code>.send()</code> method can send either text or binary data.</strong></p>
<p>A call <code>socket.send(body)</code> allows <code>body</code> in string or a binary format, including <code>Blob</code>, <code>ArrayBuffer</code>, etc. No settings are required: just send it out in any format.</p>
<p><strong>When we receive the data, text always comes as string. And for binary data, we can choose between <code>Blob</code> and <code>ArrayBuffer</code> formats.</strong></p>
<p>That’s set by <code>socket.binaryType</code> property, it’s <code>&quot;blob&quot;</code> by default, so binary data comes as <code>Blob</code> objects.</p>
<p><a href="info:blob">Blob</a> is a high-level binary object, it directly integrates with <code>&lt;a&gt;</code>, <code>&lt;img&gt;</code> and other tags, so that’s a sane default. But for binary processing, to access individual data bytes, we can change it to <code>&quot;arraybuffer&quot;</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">socket.binaryType = <span class="string">&quot;arraybuffer&quot;</span>;</span><br><span class="line">socket.onmessage = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// event.data is either a string (if text) or arraybuffer (if binary)</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Rate-limiting"><a href="#Rate-limiting" class="headerlink" title="Rate limiting"></a>Rate limiting</h2><p>Imagine, our app is generating a lot of data to send. But the user has a slow network connection, maybe on a mobile internet, outside of a city.</p>
<p>We can call <code>socket.send(data)</code> again and again. But the data will be buffered (stored) in memory and sent out only as fast as network speed allows.</p>
<p>The <code>socket.bufferedAmount</code> property stores how many bytes remain buffered at this moment, waiting to be sent over the network.</p>
<p>We can examine it to see whether the socket is actually available for transmission.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// every 100ms examine the socket and send more data  </span></span><br><span class="line"><span class="comment">// only if all the existing data was sent out</span></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (socket.bufferedAmount == <span class="number">0</span>) &#123;</span><br><span class="line">    socket.send(moreData());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="number">100</span>);</span><br></pre></td></tr></table></figure>


<h2 id="Connection-close"><a href="#Connection-close" class="headerlink" title="Connection close"></a>Connection close</h2><p>Normally, when a party wants to close the connection (both browser and server have equal rights), they send a “connection close frame” with a numeric code and a textual reason.</p>
<p>The method for that is:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket.close([code], [reason]);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>code</code> is a special WebSocket closing code (optional)</li>
<li><code>reason</code> is a string that describes the reason of closing (optional)</li>
</ul>
<p>Then the other party in the <code>close</code> event handler gets the code and the reason, e.g.:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// closing party:</span></span><br><span class="line">socket.close(<span class="number">1000</span>, <span class="string">&quot;Work complete&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// the other party</span></span><br><span class="line">socket.onclose = <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// event.code === 1000</span></span><br><span class="line">  <span class="comment">// event.reason === &quot;Work complete&quot;</span></span><br><span class="line">  <span class="comment">// event.wasClean === true (clean close)</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Most common code values:</p>
<ul>
<li><code>1000</code> – the default, normal closure (used if no <code>code</code> supplied),</li>
<li><code>1006</code> – no way to set such code manually, indicates that the connection was lost (no close frame).</li>
</ul>
<p>There are other codes like:</p>
<ul>
<li><code>1001</code> – the party is going away, e.g. server is shutting down, or a browser leaves the page,</li>
<li><code>1009</code> – the message is too big to process,</li>
<li><code>1011</code> – unexpected error on server,</li>
<li>…and so on.</li>
</ul>
<p>The full list can be found in <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6455#section-7.4.1">RFC6455, §7.4.1</a>.</p>
<p>WebSocket codes are somewhat like HTTP codes, but different. In particular, codes lower than <code>1000</code> are reserved, there’ll be an error if we try to set such a code.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in case connection is broken</span></span><br><span class="line">socket.onclose = <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// event.code === 1006</span></span><br><span class="line">  <span class="comment">// event.reason === &quot;&quot;</span></span><br><span class="line">  <span class="comment">// event.wasClean === false (no closing frame)</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<h2 id="Connection-state"><a href="#Connection-state" class="headerlink" title="Connection state"></a>Connection state</h2><p>To get connection state, additionally there’s <code>socket.readyState</code> property with values:</p>
<ul>
<li><strong><code>0</code></strong> – “CONNECTING”: the connection has not yet been established,</li>
<li><strong><code>1</code></strong> – “OPEN”: communicating,</li>
<li><strong><code>2</code></strong> – “CLOSING”: the connection is closing,</li>
<li><strong><code>3</code></strong> – “CLOSED”: the connection is closed.</li>
</ul>
<h2 id="Chat-example"><a href="#Chat-example" class="headerlink" title="Chat example"></a>Chat example</h2><p>Let’s review a chat example using browser WebSocket API and Node.js WebSocket module <a target="_blank" rel="noopener" href="https://github.com/websockets/ws">https://github.com/websockets/ws</a>. We’ll pay the main attention to the client side, but the server is also simple.</p>
<p>HTML: we need a <code>&lt;form&gt;</code> to send messages and a <code>&lt;div&gt;</code> for incoming messages:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- message form --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">&quot;publish&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;message&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Send&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- div with messages --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;messages&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>From JavaScript we want three things:</p>
<ol>
<li>Open the connection.</li>
<li>On form submission – <code>socket.send(message)</code> for the message.</li>
<li>On incoming message – append it to <code>div#messages</code>.</li>
</ol>
<p>Here’s the code:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> socket = <span class="keyword">new</span> WebSocket(<span class="string">&quot;wss://javascript.info/article/websocket/chat/ws&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// send message from the form</span></span><br><span class="line"><span class="built_in">document</span>.forms.publish.onsubmit = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> outgoingMessage = <span class="built_in">this</span>.message.value;</span><br><span class="line"></span><br><span class="line">  socket.send(outgoingMessage);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// message received - show the message in div#messages</span></span><br><span class="line">socket.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> message = event.data;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> messageElem = <span class="built_in">document</span>.createElement(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">  messageElem.textContent = message;</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">&#x27;messages&#x27;</span>).prepend(messageElem);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Server-side code is a little bit beyond our scope. Here we’ll use Node.js, but you don’t have to. Other platforms also have their means to work with WebSocket.</p>
<p>The server-side algorithm will be:</p>
<ol>
<li>Create <code>clients = new Set()</code> – a set of sockets.</li>
<li>For each accepted websocket, add it to the set <code>clients.add(socket)</code> and set <code>message</code> event listener to get its messages.</li>
<li>When a message is received: iterate over clients and send it to everyone.</li>
<li>When a connection is closed: <code>clients.delete(socket)</code>.</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ws = <span class="keyword">new</span> <span class="built_in">require</span>(<span class="string">&#x27;ws&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> wss = <span class="keyword">new</span> ws.Server(&#123;<span class="attr">noServer</span>: <span class="literal">true</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> clients = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// here we only handle websocket connections</span></span><br><span class="line">  <span class="comment">// in real project we&#x27;d have some other code here to handle non-websocket requests</span></span><br><span class="line">  wss.handleUpgrade(req, req.socket, Buffer.alloc(<span class="number">0</span>), onSocketConnect);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onSocketConnect</span>(<span class="params">ws</span>) </span>&#123;</span><br><span class="line">  clients.add(ws);</span><br><span class="line"></span><br><span class="line">  ws.on(<span class="string">&#x27;message&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">message</span>) </span>&#123;</span><br><span class="line">    message = message.slice(<span class="number">0</span>, <span class="number">50</span>); <span class="comment">// max message length will be 50</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> client <span class="keyword">of</span> clients) &#123;</span><br><span class="line">      client.send(message);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  ws.on(<span class="string">&#x27;close&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    clients.delete(ws);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>Here’s the working example:</p>
<p>[iframe src=”chat” height=”100” zip]</p>
<p>You can also download it (upper-right button in the iframe) and run it locally. Just don’t forget to install <a target="_blank" rel="noopener" href="https://nodejs.org/en/">Node.js</a> and <code>npm install ws</code> before running.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>WebSocket is a modern way to have persistent browser-server connections.</p>
<ul>
<li>WebSockets don’t have cross-origin limitations.</li>
<li>They are well-supported in browsers.</li>
<li>Can send/receive strings and binary data.</li>
</ul>
<p>The API is simple.</p>
<p>Methods:</p>
<ul>
<li><code>socket.send(data)</code>,</li>
<li><code>socket.close([code], [reason])</code>.</li>
</ul>
<p>Events:</p>
<ul>
<li><code>open</code>,</li>
<li><code>message</code>,</li>
<li><code>error</code>,</li>
<li><code>close</code>.</li>
</ul>
<p>WebSocket by itself does not include reconnection, authentication and many other high-level mechanisms. So there are client/server libraries for that, and it’s also possible to implement these capabilities manually.</p>
<p>Sometimes, to integrate WebSocket into existing projects, people run a WebSocket server in parallel with the main HTTP-server, and they share a single database. Requests to WebSocket use <code>wss://ws.site.com</code>, a subdomain that leads to the WebSocket server, while <code>https://site.com</code> goes to the main HTTP-server.</p>
<p>Surely, other ways of integration are also possible.</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/02/21/realtime-dealing/" rel="prev" title="实时交易数据">
                  <i class="fa fa-angle-left"></i> 实时交易数据
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/04/16/young-confusion/" rel="next" title="青年人，请珍惜你们的迷惘">
                  青年人，请珍惜你们的迷惘 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">The Rings</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
